<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<dom-module id="raid-calculator">
    <style>
        paper-toggle-button {
            --paper-toggle-button-checked-bar-color: #3F51B5;
            --paper-toggle-button-checked-button-color: #3F51B5;
            --paper-toggle-button-checked-ink-color: #3F51B5;
        }
    </style>
    <template>
        <div>
            <paper-material elevation="1">
                <paper-input-container>
                    <label>Immortal Lvl</label>
                    <input is="iron-input" bind-value="{{ImmLvl}}" >
                </paper-input-container>
                <paper-input-container>
                    <label>{{CurrentDamageTypeString(DamageType)}}</label>
                    <input is="iron-input" bind-value="{{Damage}}" >
                    <div suffix style="display: inline-block;">
                        <paper-checkbox checked="{{DamageType}}"></paper-checkbox>
                        <paper-tooltip style="width: 142px;">Percent or absolute damage</paper-tooltip>
                    </div>
                </paper-input-container>
                Reward: <span>{{calculate(ImmLvl, Damage, DamageType)}}</span> HS<br/>
                <div style="display: inline">
                    HP: <span>{{HP(ImmLvl, Format)}}</span>
                    <div style="display: inline-block; float: right">
                        <paper-toggle-button checked="{{Format}}" ></paper-toggle-button>
                        <paper-tooltip style="width: 137px">Scientific or ingame format</paper-tooltip>
                    </div>
                </div>
            </paper-material>
            <a href="https://www.reddit.com/r/ClickerHeroes/comments/3gj93c/clans_faq/ctywuan">Formula</a>
        </div>
    </template>
    <script>
        function scientific(Health) {
            var hp_str = Health.toString();
            if(/^\d\.\d{6,}e(\+|-)\d+$/.test(hp_str))
                hp_str = "~" + hp_str.substr(0,7) + "e" + hp_str.split("e")[1];
            return hp_str;
        }
        function ingame(Health) {
            var suffixes = ["", "K", "M", "B", "T", "q", "Q", "s", "S", "O", "N", "d", "U", "D", "!", "@", "#", "$", "%",
                "^", "&", "*"];
            var index = 0;
            var hp = Health;
            if(hp <= 9.9999e+67)
                while (hp.toString().length > 5) {
                  index++;
                  hp = Math.round(hp / 1000);
                }
            else return scientific(Health);
            return hp.toString() + suffixes[index];
        }
        Polymer({
            is: "raid-calculator",
            properties: {
                ImmLvl: {
                    type: Number,
                    value: 1
                },
                Damage: {
                    type: Number,
                    value: 0
                },
                Format: {
                    type: Boolean,
                    value: false
                },
                DamageType: {
                    type: Boolean,
                    value: false
                }
            },
            calculate: function(ImmLvl, Damage, DamageType) {
                if(isNaN(ImmLvl) || isNaN(Damage) || ImmLvl < 1 || Damage < 0) return 0;
                if (!DamageType && Damage > 100) return 0;
                var base = ImmLvl <= 12 ? ImmLvl : Math.ceil(Math.pow(2, ImmLvl - 1) / (100 + ImmLvl * 10));
                var percent = DamageType ? Math.min(Damage/(Math.pow(2, ImmLvl - 1) * 1000) * 100, 100) : Damage;
                var reward = Math.ceil(0.5 * base + 5 * base * (0.01 * percent))
                var reward_str = reward.toString();
                if(/^\d\.\d{6,}e(\+|-)\d+$/.test(reward_str))
                    reward_str = "~" + reward_str.substr(0,7) + "e" + reward_str.split("e")[1];
                return reward_str;
            },
            HP: function(ImmLvl, Format) {
                if (ImmLvl < 1 || isNaN(ImmLvl)) return 0;
                var hp = Math.pow(2, ImmLvl - 1) * 1000;
                if(Format) return ingame(hp);
                return scientific(hp);
            },
            CurrentDamageTypeString: function(DamageType) {
                if(DamageType) return "Absolute";
                return "Percent(100 * dmg/boss_hp)";
            }
        });
    </script>
</dom-module>